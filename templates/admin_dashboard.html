{% extends "base.html" %} {% block content %}

<h2 class="text-primary mb-4">Admin Dashboard</h2>

<!-- Add Parking Lot Button -->
<div class="mb-3">
  <a href="{{ url_for('add_lot') }}" class="btn btn-success"
    >+ Add Parking Lot</a
  >
</div>

<!-- Parking Lots Table -->
<div class="card shadow mb-4">
  <div class="card-header bg-dark text-white">Parking Lots</div>
  <div class="card-body">
    <table class="table table-striped table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Lot Name</th>
          <th>Price/hr</th>
          <th>Address</th>
          <th>Pincode</th>
          <th>Max Spots</th>
          <th>Available Spots</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for lot in lots %}
        <tr>
          <td>{{ lot.prime_location_name }}</td>
          <td>â‚¹{{ lot.price }}</td>
          <td>{{ lot.address }}</td>
          <td>{{ lot.pincode }}</td>
          <td>{{ lot.maximum_number_of_spots }}</td>
          <td>
            {{ lot.spots|selectattr("status","equalto","A")|list|length }}
          </td>
          <td>
            <!-- Edit Button -->
            <a
              href="{{ url_for('edit_lot', lot_id=lot.id) }}"
              class="btn btn-primary btn-sm"
              >Edit</a
            >

            <!-- Delete Button -->
            <form
              action="{{ url_for('delete_lot', lot_id=lot.id) }}"
              method="POST"
              style="display: inline"
            >
              <button
                type="submit"
                class="btn btn-danger btn-sm"
                onclick="return confirm('Are you sure you want to delete this lot?')"
              >
                Delete
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center">No parking lots available</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Parking Lot Availability Chart -->
<div class="card shadow mb-4">
  <div class="card-header bg-info text-white">
    Parking Lot Availability Overview
  </div>
  <div class="card-body">
    <canvas id="lotChart" width="400" height="150"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const lotData = {
      labels: [{% for lot in lots %}"{{ lot.prime_location_name }}",{% endfor %}],
      datasets: [
          {
              label: 'Available Spots',
              backgroundColor: 'green',
              data: [
                  {% for lot in lots %}
                      {{ lot.spots|selectattr("status","equalto","A")|list|length }},
                  {% endfor %}
              ]
          },
          {
              label: 'Occupied Spots',
              backgroundColor: 'red',
              data: [
                  {% for lot in lots %}
                      {{ lot.spots|selectattr("status","equalto","O")|list|length }},
                  {% endfor %}
              ]
          }
      ]
  };

  const ctx = document.getElementById('lotChart');
  new Chart(ctx, {
      type: 'bar',
      data: lotData,
      options: { responsive: true, plugins: { legend: { position: 'top' } } }
  });
</script>

<!-- Users Table -->
<div class="card shadow">
  <div class="card-header bg-primary text-white">Registered Users</div>
  <div class="card-body">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Full Name</th>
          <th>Username</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <td>{{ u.full_name }}</td>
          <td>{{ u.username }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="2" class="text-center">No users registered</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
