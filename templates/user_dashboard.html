{% extends "base.html" %} {% block content %}

<h2 class="text-success mb-3">Welcome, {{ session['username'] }}!</h2>

<!-- Parking Lots Table -->
<div class="card shadow mb-4">
  <div class="card-header bg-dark text-white">Available Parking Lots</div>
  <div class="card-body">
    <table class="table table-bordered table-hover text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Lot Name</th>
          <th>Price/hr</th>
          <th>Max Spots</th>
          <th>Available Spots</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for lot in lots %} {% set available_count =
        lot.spots|selectattr("status","equalto","A")|list|length %}
        <tr>
          <td>{{ lot.prime_location_name }}</td>
          <td>₹{{ lot.price }}</td>
          <td>{{ lot.maximum_number_of_spots }}</td>
          <td>{{ available_count }}</td>
          <td>
            {% if available_count > 0 %}
            <form
              method="POST"
              action="{{ url_for('reserve_spot', lot_id=lot.id) }}"
            >
              <button class="btn btn-primary btn-sm">Reserve</button>
            </form>
            {% else %}
            <button class="btn btn-secondary btn-sm" disabled>No Spots</button>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="text-center">No parking lots available</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Active & Past Reservations -->
<div class="card shadow">
  <div class="card-header bg-primary text-white">Your Parking History</div>
  <div class="card-body">
    <table class="table table-striped text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Spot</th>
          <th>Lot</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Cost</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for res in reservations %}
        <tr>
          <td>{{ res.spot.id }}</td>
          <td>{{ res.spot.lot.prime_location_name }}</td>
          <td>{{ res.parking_timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
          <td>
            {% if res.leaving_timestamp %} {{
            res.leaving_timestamp.strftime('%Y-%m-%d %H:%M:%S') }} {% else %}
            Active {% endif %}
          </td>
          <td>
            {% if res.leaving_timestamp %}
            <span class="text-success fw-bold"
              >₹{{ "%.2f"|format(res.parking_cost) }}</span
            >
            {% else %}
            <span class="text-warning fw-bold"
              >₹{{ "%.2f"|format(res.current_cost) }}</span
            >
            <small class="text-muted d-block">(Running)</small>
            {% endif %}
          </td>
          <td>
            {% if not res.leaving_timestamp %}
            <form
              method="POST"
              action="{{ url_for('release_spot', res_id=res.id) }}"
            >
              <button class="btn btn-danger btn-sm">Release</button>
            </form>
            {% else %}
            <span class="text-success">Completed</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-center">No reservations yet</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
